---
title: "Andean bird blood data exploration"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Introduction

In order to 1) select taxa for our study on the effects of gene swamping on elevational ranges; 2) inform revisions of a grant focused on the evolution of elevational ranges more broadly and 3) write a paper on the subject, we're exploring patterns of variation haemoglobin and haematocrit concentration across elevation in Andean birds. 

To begin, we're interested in the relationship between elevational range breadth and the slope of change in blood variables. We have three alternate hypotheses, which might apply to all species pairs or different species pairs individually:

**H1: Elevational generalists have shallower blood parameter slopes than elevational specialists:**  
**Prediction:** Species with broad elevational ranges show less change across elevation in haemoglobin and haematocrit concentration due to enchanced phenotypic plasticity (elevational range breadth is negatively correlated with slope of blood parameters)

**H2: Elevational generalists have steeper blood parameter slopes than elevational specialists**:   
**Prediction:** Species with broad elevational ranges show more change across elevation in haemoglobin and haematocrit concentration, as they have an enchanced ability to adapt to local conditions, perhaps due to reduced gene flow from range center to edge (elevational range breadth is positively correlated with slope of blood parameters)

**H0: No difference in blood parameter slopes between generalists and specalists**:   
**Prediction:** Adaptation across elevation unrelated to range limits (no relationship between range breadth and slope of blood parameters)

(Note: these predictions don't address *variance* in parameter slope across elevational range breadth, which may be important.)

To begin, we're going to load the data, take a look at it,and make some filtering choices.  

```{r, message=FALSE, warning=FALSE}
# load libraries
library(tidyverse, quietly = TRUE)
library(magrittr)
source("~/Dropbox/andean_range_limits/scripts/00_functions.R")

# load data
blood_df <- read.csv("~/Dropbox/andean_range_limits/data/blood_data.csv", 
                     stringsAsFactors = FALSE)

# subset columns of interest
blood_df <- cbind.data.frame(blood_df$Scientific.name, 
                             blood_df$Elevation, 
                             blood_df$Bursa,
                             blood_df$Mass.for.analyses, 
                             blood_df$tHbcorr,
                             blood_df$HctBestEstimate,
                             blood_df$Latitude..degrees.S, 
                             blood_df$Latitude.minutes,
                             blood_df$Longitude.degrees.W, 
                             blood_df$Longitude.minutes,
                             blood_df$Sex)

colnames(blood_df) <- c("species","elevation","bursa","mass","hb","hct", "lat_degrees",
                        "lat_minutes", "long_degrees", "long_minutes", "sex")

# fix longitude minutes error
blood_df$long_minutes <- blood_df$long_minutes %>% as.character() %>% as.numeric()

# fix lat long issue
blood_df$lat <- convert_lat(blood_df)*-1
blood_df$long <- convert_long(blood_df)*-1

# drop sites without locality data 
blood_df <- blood_df[!is.na(blood_df$long),]
blood_df <- blood_df[!is.na(blood_df$lat),]

# drop sites beyond plausible limits of sampling
blood_df <- blood_df[blood_df$lat>(-19),]
blood_df <- blood_df[blood_df$long<(-67),]

# drop old lat long columns
blood_df <- blood_df[,-c(7:10)]

# factor to character nonsense
blood_df$species <- as.character(blood_df$species)
blood_df$elevation <- as.numeric(as.character(blood_df$elevation))
blood_df$hb <-as.numeric(as.character(blood_df$hb))

# drop all missing records (elevation, haemoglobin, haematocrit)
blood_df <- blood_df[!is.na(blood_df$elevation),]
blood_df <- blood_df[!is.na(blood_df$hb),]
blood_df <- blood_df[!is.na(blood_df$hct),]
```

Let's take a look at the head of the dataframe: 

```{r, message=FALSE, warning=FALSE}
# simplified column names
head(blood_df)

```

As you can see, we have columns for species, elevation, presence or absence of a bursa, mass, haemoglobin, haematocrit, collection site longitude and latitude, and sex. 

Next, lets merge these data with elevational range data from [Parker et al. 1996](https://www.press.uchicago.edu/ucp/books/book/chicago/E/bo3618705.html) (what Chris calls the "Stotz" data)". We're using the parameter `all.x=TRUE`, which just means we aren't going to drop blood data if there's not a taxonomy match with the Stotz table. 

```{r,  message=FALSE, warning=FALSE}
stotz <- read.csv("~/Dropbox/andean_range_limits/data/stotz_elevation_data.csv")
stotz <- cbind.data.frame(stotz$GENUS, stotz$SPECIES, 
                          stotz$MIN, stotz$MAX, stotz$MIDPT.ELEV)
colnames(stotz) <- c("genus","species","elev_min","elev_max","elev_midpt")
stotz$binomial <- paste0(stotz$genus, " ", stotz$species)
blood_df <- merge(blood_df, stotz, by.x = "species", by.y = "binomial", all.x=TRUE)
head(blood_df)
```

How many unique species and records are in this dataset?  

```{r,  message=FALSE, warning=FALSE}
length(unique(blood_df$species)) # number of unique species
nrow(blood_df) # number of unique records
```

Next, let's do some basic filtering, and drop rows with fewer than 5 unique elevational localities, and fewer than 15 datapoints total (admittedly a little stringent).    

```{r,  message=FALSE, warning=FALSE}
# drop all species with fewer than 5 unique elevational records
elev_cutoff <- c()
for(i in blood_df$species){
  tmp <- blood_df[blood_df$species==i,]
  if(length(unique(tmp$elevation))>5){elev_cutoff[i] <- as.character(tmp$species[1])}
}
elev_cutoff <- as.vector(elev_cutoff)

# drop all species with fewer than 15 total records
sp_list <- c()
for(i in blood_df$species){
  tmp <- blood_df[blood_df$species==i,]
  if(nrow(tmp)>15){sp_list[i] <- as.character(tmp$species[1])}
}
sp_list <- as.vector(sp_list)

# find overlap in filters
sp_list <- intersect(sp_list, elev_cutoff)

# subset down to "good" species
blood_df_sub <- blood_df[blood_df$species %in% sp_list,]

length(unique(blood_df_sub$species)) # number of unique species
nrow(blood_df_sub) # number of unique records

```

Which species failed to pick up elevational range data?  

```{r,  message=FALSE, warning=FALSE}
blood_df_sub[is.na(blood_df_sub$elev_min),]$species %>% unique() %>% length() 
```

Bummer. Let's take a look them:   
 
```{r,  message=FALSE, warning=FALSE}
missing <- blood_df_sub[is.na(blood_df_sub$elev_min),]$species %>% unique()
print(missing)
```

All can be explained by taxonomic changes and / or typos. Eyeballing the Stotz data, we can fill in the gaps tediously.

```{r}
blood_df_sub[blood_df_sub$species==missing[1],][12] <- 2350 #Anairetes nigrocristatus
blood_df_sub[blood_df_sub$species==missing[1],][13] <- 4200 #Anairetes nigrocristatus
blood_df_sub[blood_df_sub$species==missing[2],][12] <- 0    #Anairetes reguloides
blood_df_sub[blood_df_sub$species==missing[2],][13] <- 2900 #Anairetes reguloides
blood_df_sub[blood_df_sub$species==missing[3],][12] <- 0    #Cinclodes albiventris
blood_df_sub[blood_df_sub$species==missing[3],][13] <- 4900 #Cinclodes albiventris
blood_df_sub[blood_df_sub$species==missing[4],][12] <- 2000 #Diglossa brunneiventris
blood_df_sub[blood_df_sub$species==missing[4],][13] <- 4200 #Diglossa brunneiventris
blood_df_sub[blood_df_sub$species==missing[5],][12] <- 2500 #Diglossa mystacalis
blood_df_sub[blood_df_sub$species==missing[5],][13] <- 3600 #Diglossa mystacalis
blood_df_sub[blood_df_sub$species==missing[6],][12] <- 800  #Lepidothrix coeruleocapilla
blood_df_sub[blood_df_sub$species==missing[6],][13] <- 1900 #Lepidothrix coeruleocapilla
blood_df_sub[blood_df_sub$species==missing[7],][12] <- 0    #Lepidothrix coronata
blood_df_sub[blood_df_sub$species==missing[7],][13] <- 1400 #Lepidothrix coronata
blood_df_sub[blood_df_sub$species==missing[8],][12] <- 1400 #Myiothlypis coronata
blood_df_sub[blood_df_sub$species==missing[8],][13] <- 2800 #Myiothlypis coronata
blood_df_sub[blood_df_sub$species==missing[9],][12] <- 2400 #Myiothlypis luteoviridis
blood_df_sub[blood_df_sub$species==missing[9],][13] <- 3400 #Myiothlypis luteoviridis
blood_df_sub[blood_df_sub$species==missing[10],][12] <- 0    #Pipraeidea bonariensis
blood_df_sub[blood_df_sub$species==missing[10],][13] <- 3000 #Pipraeidea bonariensis
blood_df_sub[blood_df_sub$species==missing[11],][12] <- 0    #Spinus magellanicus
blood_df_sub[blood_df_sub$species==missing[11],][13] <- 3500 #Spinus magellanicus
blood_df_sub[blood_df_sub$species==missing[12],][12] <- 0    #Troglodytes aedon
blood_df_sub[blood_df_sub$species==missing[12],][13] <- 4600 #Troglodytes aedon
```

Now how many gaps are there?  

```{r,  message=FALSE, warning=FALSE}
missing <- blood_df_sub[is.na(blood_df_sub$elev_min),]$species %>% unique()
length(missing)
```

None! Perfect.  

Now let's classify each species as either an elevational specialist (range size <1500m), generalist (range size >2500m), or neither (range size 1500-2499 m; or data deficient)  

```{r,  message=FALSE, warning=FALSE}
blood_df_sub$elev_range <- NA
blood_df_sub$elev_range <- blood_df_sub$elev_max-blood_df_sub$elev_min
blood_df_sub$elev_guild <- NA
blood_df_sub$elev_guild[blood_df_sub$elev_range<1500] <- "specialist"
blood_df_sub$elev_guild[blood_df_sub$elev_range>2500] <- "generalist"
blood_df_sub$elev_guild[is.na(blood_df_sub$elev_guild)] <- "neither"
```


How many datapoints in each category do we have?   

```{r,  warning=FALSE}
table(blood_df_sub$elev_guild)
```

Finally, let's extract slope angle from a raster file, so we can calculate an average for each species. (Note we have a lot of missing data in these columns; really just a placeholder for future analyses)  

```{r,  message=FALSE, warning=FALSE}
# load raster libraries
library(raster)
library(sp)

# get raster
peru_elev <- raster("~/Dropbox/andean_range_limits/data/PER_msk_alt.grd")
peru_terrain <- terrain(peru_elev, opt = c("slope"), unit = "degrees")

# load elevation data
pts <- as.matrix(cbind(blood_df_sub$long, blood_df_sub$lat))
pts <- SpatialPoints(pts)
proj <- CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")
proj4string(pts) <- proj
slope <- raster::extract(peru_terrain, pts, method='bilinear',small=TRUE)
blood_df_sub$slope <- slope
```


Next, let's calculate the slope of haemoglobin and haematocrit—and the average slope angle for different species—using the `blood_slope()` function I've written.  

```{r,  message=FALSE, warning=FALSE}
# create new dataframe
slope_df <- blood_slope(blood_df_sub)
head(slope_df)
```

As a first pass, let's look at the relationship between slope of haemoglobin and haematocrit across elevation and range breadth:

```{r, message=FALSE, warning=FALSE}

# all slope values
lm(slope_hb ~ elev_range, slope_df) %>% summary()
lm(slope_hct ~ elev_range, slope_df) %>% summary()

```

Not much going on. Let's look at the relationship between slope of haemoglobin and haematocrit across elevation and average slope (mountainside) angle:  

```{r, message=FALSE, warning=FALSE}
# all slope values
lm(slope_hb ~ avg_slope, slope_df) %>% summary()
lm(slope_hct ~ avg_slope, slope_df) %>% summary()
```

A significant positive effect of slope angle on haematocrit concentration, but it explains almost no variation.  

Lastly, let's take a look at the overall trends: 

```{r, echo=FALSE, fig.height=4, fig.width=8}
hb_df <- cbind.data.frame(slope_df$species, slope_df$elev_range, slope_df$avg_slope, slope_df$slope_hb)
hct_df <- cbind.data.frame(slope_df$species, slope_df$elev_range, slope_df$avg_slope, slope_df$slope_hct)
hb_df$paramater <- rep("haemoglobin",nrow(hb_df))
hct_df$paramater <- rep("haematocrit",nrow(hct_df))
colnames(hb_df) <- c("species","elev_range","avg_slope","slope","parameter")
colnames(hct_df) <- c("species","elev_range","avg_slope","slope","parameter")
plot_df <- rbind.data.frame(hb_df,hct_df)
tail(plot_df)

ggplot(plot_df, aes(x=elev_range, y=slope)) +
  facet_wrap(~parameter,scales="free_y") +
  geom_point(pch=21,stroke=1,color="red3") +
  theme_bw() +
  xlab("elevational range breadth") +
  ylab("slope (blood parameter)")

ggplot(plot_df, aes(x=avg_slope, y=slope)) +
  facet_wrap(~parameter,scales="free_y") +
  geom_point(pch=21,stroke=1,color="red3") +
  theme_bw() +
  xlab("average mountain slope angle")+
  ylab("slope (blood parameter)")

```

So—at least given our current filtering assumptions, and at the level of all species in the dataset—it seems like we can't reject **H0**.   

## Species-specific plots  

Finally, let's plot raw data from some species we're interested in:  

```{r,echo=FALSE, warning=FALSE, message=FALSE, fig.height=16, fig.width=12}

focal <- c("Permnornis","Pseudocolaptes","Ochthoeca","Mionectes","Pipraeidea",
           "Catamenia","Diglossa","Haplospiza","Phrygilus","Troglodytes",
           "Xenaida","Turdus","Phaethornis","Eutoxeres","Thalurania","Amazilia",
           "Tangara","Sicalis","Ammodramus","Zonotrichia","Pheucticus","Spinus",
           "Euphonia")

blood_df_selection <- blood_df_sub[blood_df_sub$genus %in% focal,]

ggplot(blood_df_selection, aes(x=elevation, y=hb)) +
  facet_wrap(~species,scales="free", ncol=3) +
  geom_point(pch=21,stroke=1,aes(color=species),show.legend = FALSE) +
  geom_smooth(method="lm",se=FALSE,linetype="dashed",color="black") +
  theme_bw() +
  xlab("elevation")+
  ylab("hb")

ggplot(blood_df_selection, aes(x=elevation, y=hct)) +
  facet_wrap(~species,scales="free", ncol=3) +
  geom_point(pch=21,stroke=1,aes(color=species),show.legend = FALSE) +
  geom_smooth(method="lm",se=FALSE,linetype="dashed",color="black") +
  theme_bw() +
  xlab("elevation")+
  ylab("hct")



```


Lastly, let's export scatter plots for all species that pass our filters. 

```{r, warning=FALSE, message=FALSE}

multispecies_hb <- ggplot(blood_df_sub, aes(x=elevation, y=hb)) +
  facet_wrap(~species,scales="free") +
  geom_point(pch=21,stroke=1,aes(color=species),show.legend = FALSE) +
  geom_smooth(method="lm",se=FALSE,linetype="dashed",color="black") +
  theme_bw() +
  xlab("elevation")+
  ylab("hb")

pdf("~/Dropbox/andean_range_limits/figures/multispecies_hb.pdf",width=24,height=20)
multispecies_hb
dev.off()

multispecies_hct <- ggplot(blood_df_sub, aes(x=elevation, y=hct)) +
  facet_wrap(~species,scales="free") +
  geom_point(pch=21,stroke=1,aes(color=species),show.legend = FALSE) +
  geom_smooth(method="lm",se=FALSE,linetype="dashed",color="black") +
  theme_bw() +
  xlab("elevation")+
  ylab("hct")

pdf("~/Dropbox/andean_range_limits/figures/multispecies_hct.pdf",width=24,height=20)
multispecies_hct
dev.off()
```
